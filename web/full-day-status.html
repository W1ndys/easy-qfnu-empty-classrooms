<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•™å®¤å…¨å¤©çŠ¶æ€ - QFNU</title>
    <link href="/static/css/style.css" rel="stylesheet">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        /* çŠ¶æ€é¢œè‰²å®šä¹‰ - ç§»é™¤èƒŒæ™¯è‰²ï¼Œåªä¿ç•™æ–‡æœ¬é¢œè‰²æˆ–é»˜è®¤ */
        /* ä½¿ç”¨ emoji åï¼ŒèƒŒæ™¯è‰²å¯èƒ½ä¸éœ€è¦äº†ï¼Œæˆ–è€…ä¿ç•™æ·¡è‰²èƒŒæ™¯ */
        .status-1 { color: #DC2626; } /* æ­£å¸¸ä¸Šè¯¾ */
        .status-2 { color: #EA580C; } /* å€Ÿç”¨ */
        .status-3 { color: #4B5563; } /* é”å®š */
        .status-4 { color: #7C3AED; } /* è€ƒè¯• */
        .status-5 { color: #10B981; } /* ç©ºé—² */
        .status-6 { color: #2563EB; } /* å›ºå®šè°ƒè¯¾ */
        .status-7 { color: #0891B2; } /* ä¸´æ—¶è°ƒè¯¾ */
        .status-8 { color: #059669; } /* å®Œå…¨ç©ºé—² */
        .status-9 { color: #DB2777; } /* è·¨æ¨¡å¼ */

        /* è¡¨æ ¼æ¨ªå‘æ»šåŠ¨ */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* å›ºå®šé¦–åˆ— */
        .sticky-col {
            position: sticky;
            left: 0;
            background: white;
            z-index: 10;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        }
    </style>
</head>
<body class="bg-gray-50 font-sans antialiased" x-data="fullDayApp()">

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200 px-4">
        <div class="h-14 flex items-center justify-between">
            <a href="/" class="text-gray-500 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            <h1 class="text-lg font-semibold">æ•™å®¤å…¨å¤©çŠ¶æ€</h1>
            <div class="w-6"></div>
        </div>
    </header>

    <main class="px-4 py-4 max-w-5xl mx-auto space-y-4">

        <!-- Permission Warning -->
        <div x-show="!hasPermission && !statusLoading" x-transition
            class="bg-red-50 border border-red-200 rounded-2xl p-4 shadow-sm">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-red-800 font-semibold">æƒé™ä¸è¶³</h3>
                    <p class="text-red-600 text-sm mt-1">å½“å‰è´¦å·æ— æƒé™è®¿é—®æ•™åŠ¡ç³»ç»ŸæŸ¥è¯¢æ¥å£ï¼Œè¯·æ£€æŸ¥è´¦å·çŠ¶æ€ã€‚</p>
                </div>
            </div>
        </div>

        <!-- System Status Warning (Not in teaching calendar) -->
        <div x-show="!inTeachingCalendar && !statusLoading" x-transition
            class="bg-amber-50 border border-amber-200 rounded-2xl p-4 shadow-sm">
            <div class="flex items-center space-x-3">
                <div class="flex-shrink-0">
                    <svg class="w-6 h-6 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
                <div>
                    <h3 class="text-amber-800 font-semibold">æç¤º</h3>
                    <p class="text-amber-600 text-sm mt-1">å½“å‰æ—¥æœŸä¸åœ¨æ•™å­¦å‘¨å†å†…ï¼ŒæŸ¥è¯¢ç»“æœå¯èƒ½ä¸å‡†ç¡®ã€‚</p>
                </div>
            </div>
        </div>

        <!-- Search Form -->
        <div class="bg-white rounded-2xl p-4 shadow-sm space-y-4">
            <!-- Building Input -->
            <div>
                <label class="block text-sm font-medium text-gray-500 mb-1.5 ml-1">æ•™å­¦æ¥¼</label>
                <input type="text" x-model="form.building"
                    class="w-full bg-gray-100 rounded-xl py-3 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-[#885021]/20"
                    placeholder="ä¾‹å¦‚ï¼šè€æ–‡å²æ¥¼">
            </div>

            <!-- Date Selection -->
            <div>
                <label class="block text-sm font-medium text-gray-500 mb-1.5 ml-1">æ—¥æœŸ</label>

                <!-- Quick Select Buttons -->
                <div class="bg-gray-100 p-1 rounded-xl flex mb-2">
                    <template x-for="(label, idx) in quickDateLabels" :key="idx">
                        <button @click="setQuickDate(idx)"
                            :class="form.offset === idx && !useCustomDate ? 'bg-white text-black shadow-sm' : 'text-gray-500'"
                            class="flex-1 py-2 text-[13px] font-medium rounded-lg transition-all"
                            x-text="label"></button>
                    </template>
                    <button @click="toggleCustomDate()"
                        :class="useCustomDate ? 'bg-white text-black shadow-sm' : 'text-gray-500 hover:text-gray-700'"
                        class="flex-1 py-1.5 text-[13px] font-medium rounded-lg transition-all duration-200">
                        è‡ªå®šä¹‰
                    </button>
                </div>

                <!-- Custom Date Input -->
                <div x-show="useCustomDate" x-transition class="space-y-2">
                    <div class="flex items-center space-x-2">
                        <div class="flex-1 relative">
                            <input type="number" x-model.number="customOffset" min="0" max="180"
                                @input="updateCustomOffset()"
                                class="w-full bg-gray-100 rounded-xl py-3 px-4 text-[15px] focus:outline-none focus:ring-2 focus:ring-[#885021]/20 transition-all"
                                placeholder="è¾“å…¥å¤©æ•°">
                        </div>
                        <span class="text-gray-500 text-sm whitespace-nowrap">å¤©å</span>
                    </div>
                    <p class="text-xs text-gray-400 ml-1" x-text="customDatePreview"></p>
                </div>
            </div>

            <!-- Query Button -->
            <button @click="search" :disabled="loading || !form.building"
                class="w-full bg-[#885021] text-white font-semibold py-3.5 rounded-xl disabled:opacity-70 flex items-center justify-center">
                <span x-show="!loading">æŸ¥è¯¢å…¨å¤©çŠ¶æ€</span>
                <span x-show="loading" class="flex items-center">
                    <svg class="animate-spin -ml-1 mr-2 h-5 w-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                    </svg>
                    æŸ¥è¯¢ä¸­...
                </span>
            </button>
        </div>

        <!-- Legend -->
        <div x-show="hasSearched" class="bg-white rounded-2xl p-4 shadow-sm">
            <h3 class="text-sm font-medium text-gray-700 mb-3">çŠ¶æ€å›¾ä¾‹</h3>
            <div class="grid grid-cols-3 gap-2 text-xs">
                <template x-for="item in legendItems" :key="item.id">
                    <div class="flex items-center space-x-2">
                        <span class="text-base" x-text="item.emoji"></span>
                        <span class="text-gray-600" x-text="item.name"></span>
                    </div>
                </template>
            </div>
        </div>

        <!-- Results Table -->
        <div x-show="hasSearched && resultData" class="bg-white rounded-2xl shadow-sm overflow-hidden">
            <!-- Info Bar -->
            <div class="p-4 border-b border-gray-100">
                <p class="text-sm text-gray-600">
                    <span x-text="resultData.building"></span> Â·
                    <span x-text="resultData.date"></span> Â·
                    <span x-text="resultData.current_term"></span> å­¦æœŸ Â·
                    ç¬¬<span x-text="resultData.week"></span>å‘¨ Â·
                    æ˜ŸæœŸ<span x-text="resultData.day_of_week"></span>
                </p>
            </div>

            <!-- Status Table -->
            <div class="table-container">
                <table class="w-full text-sm">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="sticky-col px-3 py-3 text-left font-medium text-gray-700 min-w-[100px]">æ•™å®¤</th>
                            <template x-for="node in resultData.node_list" :key="node.node_index">
                                <th class="px-1 py-3 text-center font-medium text-gray-700 min-w-[40px]"
                                    x-text="node.node_name"></th>
                            </template>
                        </tr>
                    </thead>
                    <tbody>
                        <template x-for="room in resultData.classrooms" :key="room.room_name">
                            <tr class="border-t border-gray-100">
                                <td class="sticky-col px-3 py-3 font-medium text-gray-800 bg-white" x-text="room.room_name"></td>
                                <template x-for="(status, idx) in room.status" :key="idx">
                                    <td class="px-1 py-2 text-center text-base" x-text="getEmoji(status.status_id)">
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Empty State -->
        <div x-show="hasSearched && !loading && !resultData" class="py-10 text-center text-gray-400">
            <p>æš‚æ— æ•°æ®</p>
        </div>

        <!-- WeChat QR Code Promotion -->
        <div class="bg-white rounded-2xl p-6 shadow-sm mt-4 text-center">
            <h3 class="text-[#885021] font-semibold mb-3">æ‰«ç å…³æ³¨å…¬ä¼—å·</h3>
            <p class="text-gray-600 text-sm mb-4 px-2">ç»©ç‚¹è®¡ç®—ã€è€ƒè¯•å®‰æ’ã€é€‰è¯¾ç»“æœã€é¢„é€‰è¯¾æŸ¥è¯¢ç­‰æ›´å¤šä¾¿æ·å·¥å…·ï¼Œæ¬¢è¿å…³æ³¨å¾®ä¿¡å…¬ä¼—å·</p>
            <div class="flex justify-center">
                <img src="/static/images/qrcode.png" alt="å¾®ä¿¡å…¬ä¼—å·äºŒç»´ç " class="w-48 h-48 rounded-lg shadow-sm">
            </div>
            <p class="text-gray-400 text-xs mt-3">è·å–æœ€æ–°ç©ºæ•™å®¤ä¿¡æ¯ä¸æ ¡å›­æœåŠ¡</p>
        </div>
    </main>

    <script>
        function fullDayApp() {
            return {
                // System status
                statusLoading: true,
                inTeachingCalendar: true,
                hasPermission: true,
                currentWeek: 0,
                currentTerm: '',

                loading: false,
                hasSearched: false,
                resultData: null,

                form: {
                    building: '',
                    offset: 0
                },

                // Date selection
                quickDateLabels: ['ä»Šå¤©', 'æ˜å¤©', 'åå¤©'],
                useCustomDate: false,
                customOffset: 3,

                // Computed: custom date preview
                get customDatePreview() {
                    if (!this.useCustomDate) return '';
                    const date = new Date();
                    date.setDate(date.getDate() + this.customOffset);
                    const weekDays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                    return `ç›®æ ‡æ—¥æœŸ: ${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} (æ˜ŸæœŸ${weekDays[date.getDay()]})`;
                },

                // Computed: displayed results (pagination)
                get displayedResults() {
                    return this.results.slice(0, this.displayLimit);
                },

                // Initialize: check system status
                async init() {
                    await this.checkStatus();
                },

                // Check if system is available
                async checkStatus() {
                    this.statusLoading = true;
                    try {
                        const res = await axios.get('/api/v1/status');
                        this.inTeachingCalendar = res.data.in_teaching_calendar;
                        this.currentWeek = res.data.current_week;
                        this.currentTerm = res.data.current_term;
                        this.hasPermission = res.data.has_permission !== false; // Default to true if undefined
                    } catch (error) {
                        console.error('Failed to check status:', error);
                        this.inTeachingCalendar = false;
                        this.hasPermission = true; // Assume permission if status check fails (or maybe false? stick to true to avoid noise)
                    } finally {
                        this.statusLoading = false;
                    }
                },

                // Set quick date (today, tomorrow, day after)
                setQuickDate(offset) {
                    this.useCustomDate = false;
                    this.form.offset = offset;
                },

                // Toggle custom date mode
                toggleCustomDate() {
                    this.useCustomDate = !this.useCustomDate;
                    if (this.useCustomDate) {
                        this.form.offset = this.customOffset;
                    }
                },

                // Update offset when custom input changes
                updateCustomOffset() {
                    if (this.customOffset < 0) this.customOffset = 0;
                    if (this.customOffset > 180) this.customOffset = 180;
                    this.form.offset = this.customOffset;
                },

                legendItems: [
                    { id: 1, emoji: 'ğŸ”´', name: 'æ­£å¸¸ä¸Šè¯¾' },
                    { id: 2, emoji: 'ğŸŸ ', name: 'å€Ÿç”¨' },
                    { id: 3, emoji: 'ğŸ”’', name: 'é”å®š' },
                    { id: 4, emoji: 'ğŸŸ£', name: 'è€ƒè¯•' },
                    { id: 5, emoji: 'ğŸŸ¢', name: 'ç©ºé—²' },
                    { id: 6, emoji: 'ğŸ”µ', name: 'å›ºå®šè°ƒè¯¾' },
                    { id: 7, emoji: 'ğŸ’ ', name: 'ä¸´æ—¶è°ƒè¯¾' },
                    { id: 8, emoji: 'ğŸŒ³', name: 'å®Œå…¨ç©ºé—²' },
                    { id: 9, emoji: 'ğŸŒ¸', name: 'è·¨æ¨¡å¼' },
                ],

                getEmoji(statusId) {
                    const item = this.legendItems.find(i => i.id === statusId);
                    return item ? item.emoji : '';
                },

                async search() {
                    if (!this.form.building) return;

                    this.loading = true;
                    this.hasSearched = false;
                    this.resultData = null;

                    try {
                        const res = await axios.post('/api/v1/query-full-day', {
                            building: this.form.building,
                            date_offset: this.form.offset
                        });

                        this.resultData = res.data;
                        this.hasSearched = true;
                    } catch (error) {
                        console.error(error);
                        alert(error.response?.data?.error || 'æŸ¥è¯¢å¤±è´¥');
                    } finally {
                        this.loading = false;
                    }
                },


            }
        }
    </script>
</body>
</html>
